<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Single studies using the CohortMethod package • CohortMethod</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Single studies using the CohortMethod package">
<meta property="og:description" content="CohortMethod">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CohortMethod</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">5.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MultipleAnalyses.html">Running multiple analyses at once using the CohortMethod package</a>
    </li>
    <li>
      <a href="../articles/SingleStudies.html">Single studies using the CohortMethod package</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
<li>
  <a href="https://github.com/OHDSI/CohortMethod/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Single studies using the CohortMethod
package</h1>
                        <h4 data-toc-skip class="author">Martijn J.
Schuemie, Marc A. Suchard and Patrick Ryan</h4>
            
            <h4 data-toc-skip class="date">2023-02-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/CohortMethod/blob/HEAD/vignettes/SingleStudies.Rmd" class="external-link"><code>vignettes/SingleStudies.Rmd</code></a></small>
      <div class="hidden name"><code>SingleStudies.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette describes how you can use the <code>CohortMethod</code>
package to perform a single new-user cohort study. We will walk through
all the steps needed to perform an exemplar study, and we have selected
the well-studied topic of the effect of coxibs versus non-selective
non-steroidal anti-inflammatory drugs (NSAIDs) on gastrointestinal (GI)
bleeding-related hospitalization. For simplicity, we focus on one coxib
– celecoxib – and one non-selective NSAID – diclofenac.</p>
</div>
<div class="section level2">
<h2 id="installation-instructions">Installation instructions<a class="anchor" aria-label="anchor" href="#installation-instructions"></a>
</h2>
<p>Before installing the <code>CohortMethod</code> package make sure you
have Java available. Java can be downloaded from <a href="http://www.java.com" class="external-link">www.java.com</a>. For Windows users, RTools
is also necessary. RTools can be downloaded from <a href="http://cran.r-project.org/bin/windows/Rtools/" class="external-link">CRAN</a>.</p>
<p>The <code>CohortMethod</code> package is currently maintained in a <a href="https://github.com/OHDSI/CohortMethod" class="external-link">Github repository</a>, and
has dependencies on other packages in Github. All of these packages can
be downloaded and installed from within R using the <code>drat</code>
package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"ohdsi/CohortMethod"</span><span class="op">)</span></span></code></pre></div>
<p>Once installed, you can type <code><a href="https://ohdsi.github.io/CohortMethod" class="external-link">library(CohortMethod)</a></code> to
load the package.</p>
</div>
<div class="section level2">
<h2 id="data-extraction">Data extraction<a class="anchor" aria-label="anchor" href="#data-extraction"></a>
</h2>
<p>The first step in running the <code>CohortMethod</code> is extracting
all necessary data from the database server holding the data in the
Observational Medical Outcomes Partnership (OMOP) Common Data Model
(CDM) format.</p>
<div class="section level3">
<h3 id="configuring-the-connection-to-the-server">Configuring the connection to the server<a class="anchor" aria-label="anchor" href="#configuring-the-connection-to-the-server"></a>
</h3>
<p>We need to tell R how to connect to the server where the data are.
<code>CohortMethod</code> uses the <code>DatabaseConnector</code>
package, which provides the <code>createConnectionDetails</code>
function. Type <code>?createConnectionDetails</code> for the specific
settings required for the various database management systems (DBMS).
For example, one might connect to a PostgreSQL database using this
code:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">createConnectionDetails</span><span class="op">(</span>dbms <span class="op">=</span> <span class="st">"postgresql"</span>,</span>
<span>                                             server <span class="op">=</span> <span class="st">"localhost/ohdsi"</span>,</span>
<span>                                             user <span class="op">=</span> <span class="st">"joe"</span>,</span>
<span>                                             password <span class="op">=</span> <span class="st">"supersecret"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdmDatabaseSchema</span> <span class="op">&lt;-</span> <span class="st">"my_cdm_data"</span></span>
<span><span class="va">resultsDatabaseSchema</span> <span class="op">&lt;-</span> <span class="st">"my_results"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>sqlRenderTempEmulationSchema <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p>The last two lines define the <code>cdmDatabaseSchema</code> and
<code>resultSchema</code> variables. We’ll use these later to tell R
where the data in CDM format live, and where we want to write
intermediate tables. Note that for Microsoft SQL Server, databaseschemas
need to specify both the database and the schema, so for example
<code>cdmDatabaseSchema &lt;- "my_cdm_data.dbo"</code>.</p>
</div>
<div class="section level3">
<h3 id="preparing-the-exposures-and-outcomes">Preparing the exposures and outcome(s)<a class="anchor" aria-label="anchor" href="#preparing-the-exposures-and-outcomes"></a>
</h3>
<p>We need to define the exposures and outcomes for our study. One could
use an external cohort definition tools, but in this example we do this
by writing SQL statements against the OMOP CDM that populate a table of
events in which we are interested. The resulting table should have the
same structure as the <code>cohort</code> table in the CDM. This means
it should have the fields <code>cohort_definition_id</code>,
<code>cohort_start_date</code>, <code>cohort_end_date</code>,and
<code>subject_id</code>.</p>
<p>For our example study, we have created a file called
<em>coxibVsNonselVsGiBleed.sql</em> with the following contents:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">/***********************************</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">File coxibVsNonselVsGiBleed.sql</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">***********************************/</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> OBJECT_ID(<span class="st">'@resultsDatabaseSchema.coxibVsNonselVsGiBleed'</span>, <span class="st">'U'</span>) <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">TABLE</span> @resultsDatabaseSchema.coxibVsNonselVsGiBleed;</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> @resultsDatabaseSchema.coxibVsNonselVsGiBleed (</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  cohort_definition_id <span class="dt">INT</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  cohort_start_date <span class="dt">DATE</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    cohort_end_date <span class="dt">DATE</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    subject_id BIGINT</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> @resultsDatabaseSchema.coxibVsNonselVsGiBleed (</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    cohort_definition_id,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    cohort_start_date,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    cohort_end_date,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    subject_id</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dv">1</span>, <span class="co">-- Exposure</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    drug_era_start_date,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    drug_era_end_date,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    person_id</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> @cdmDatabaseSchema.drug_era</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> drug_concept_id <span class="op">=</span> <span class="dv">1118084</span>;<span class="co">-- celecoxib</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> @resultsDatabaseSchema.coxibVsNonselVsGiBleed (</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    cohort_definition_id,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    cohort_start_date,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    cohort_end_date,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    subject_id</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dv">2</span>, <span class="co">-- Comparator</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    drug_era_start_date,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    drug_era_end_date,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    person_id</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> @cdmDatabaseSchema.drug_era</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> drug_concept_id <span class="op">=</span> <span class="dv">1124300</span>; <span class="co">--diclofenac</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> @resultsDatabaseSchema.coxibVsNonselVsGiBleed (</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    cohort_definition_id,</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    cohort_start_date,</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    cohort_end_date,</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    subject_id</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dv">3</span>, <span class="co">-- Outcome</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    condition_start_date,</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    condition_end_date,</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    condition_occurrence.person_id</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> @cdmDatabaseSchema.condition_occurrence</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> @cdmDatabaseSchema.visit_occurrence</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> condition_occurrence.visit_occurrence_id <span class="op">=</span> visit_occurrence.visit_occurrence_id</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> condition_concept_id <span class="kw">IN</span> (</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT</span> descendant_concept_id</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> @cdmDatabaseSchema.concept_ancestor</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">WHERE</span> ancestor_concept_id <span class="op">=</span> <span class="dv">192671</span> <span class="co">-- GI - Gastrointestinal haemorrhage</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> visit_occurrence.visit_concept_id <span class="kw">IN</span> (<span class="dv">9201</span>, <span class="dv">9203</span>);</span></code></pre></div>
<p>This is parameterized SQL which can be used by the
<code>SqlRender</code> package. We use parameterized SQL so we do not
have to pre-specify the names of the CDM and result schemas. That way,
if we want to run the SQL on a different schema, we only need to change
the parameter values; we do not have to change the SQL code. By also
making use of translation functionality in <code>SqlRender</code>, we
can make sure the SQL code can be run in many different
environments.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/SqlRender/" class="external-link">SqlRender</a></span><span class="op">)</span></span>
<span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/SqlRender/reference/readSql.html" class="external-link">readSql</a></span><span class="op">(</span><span class="st">"coxibVsNonselVsGiBleed.sql"</span><span class="op">)</span></span>
<span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/SqlRender/reference/render.html" class="external-link">render</a></span><span class="op">(</span><span class="va">sql</span>,</span>
<span>              cdmDatabaseSchema <span class="op">=</span> <span class="va">cdmDatabaseSchema</span>,</span>
<span>              resultsDatabaseSchema <span class="op">=</span> <span class="va">resultsDatabaseSchema</span><span class="op">)</span></span>
<span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/SqlRender/reference/translate.html" class="external-link">translate</a></span><span class="op">(</span><span class="va">sql</span>, targetDialect <span class="op">=</span> <span class="va">connectionDetails</span><span class="op">$</span><span class="va">dbms</span><span class="op">)</span></span>
<span></span>
<span><span class="va">connection</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="va">connectionDetails</span><span class="op">)</span></span>
<span><span class="fu">executeSql</span><span class="op">(</span><span class="va">connection</span>, <span class="va">sql</span><span class="op">)</span></span></code></pre></div>
<p>In this code, we first read the SQL from the file into memory. In the
next line, we replace the two parameter names with the actual values. We
then translate the SQL into the dialect appropriate for the DBMS we
already specified in the <code>connectionDetails</code>. Next, we
connect to the server, and submit the rendered and translated SQL.</p>
<p>If all went well, we now have a table with the events of interest. We
can see how many events per type:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"SELECT cohort_definition_id, COUNT(*) AS count"</span>,</span>
<span>             <span class="st">"FROM @resultsDatabaseSchema.coxibVsNonselVsGiBleed"</span>,</span>
<span>             <span class="st">"GROUP BY cohort_definition_id"</span><span class="op">)</span></span>
<span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/SqlRender/reference/render.html" class="external-link">render</a></span><span class="op">(</span><span class="va">sql</span>, resultsDatabaseSchema <span class="op">=</span> <span class="va">resultsDatabaseSchema</span><span class="op">)</span></span>
<span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/SqlRender/reference/translate.html" class="external-link">translate</a></span><span class="op">(</span><span class="va">sql</span>, targetDialect <span class="op">=</span> <span class="va">connectionDetails</span><span class="op">$</span><span class="va">dbms</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">querySql</span><span class="op">(</span><span class="va">connection</span>, <span class="va">sql</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   cohort_concept_id count</span></span>
<span><span class="co">## 1                 1 50000</span></span>
<span><span class="co">## 2                 2 50000</span></span>
<span><span class="co">## 3                 3 15000</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="extracting-the-data-from-the-server">Extracting the data from the server<a class="anchor" aria-label="anchor" href="#extracting-the-data-from-the-server"></a>
</h3>
<p>Now we can tell <code>CohortMethod</code> to define the cohorts based
on our events, construct covariates, and extract all necessary data for
our analysis.</p>
<p><strong>Important</strong>: The target and comparator drug must not
be included in the covariates, including any descendant concepts. You
will need to manually add the drugs and descendants to the
<code>excludedCovariateConceptIds</code> of the covariate settings. In
this example code we exclude all NSAIDs from the covariates by pointing
to the concept ID of the NSAID class and specifying
<code>addDescendantsToExclude = TRUE</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nsaids</span> <span class="op">&lt;-</span> <span class="fl">21603933</span></span>
<span></span>
<span><span class="co"># Define which types of covariates must be constructed:</span></span>
<span><span class="va">covSettings</span> <span class="op">&lt;-</span> <span class="fu">createDefaultCovariateSettings</span><span class="op">(</span>excludedCovariateConceptIds <span class="op">=</span> <span class="va">nsaids</span>,</span>
<span>                                              addDescendantsToExclude <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Load data:</span></span>
<span><span class="va">cohortMethodData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getDbCohortMethodData.html">getDbCohortMethodData</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="va">cdmDatabaseSchema</span>,</span>
<span>  targetId <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  comparatorId <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  outcomeIds <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  studyStartDate <span class="op">=</span> <span class="st">""</span>,</span>
<span>  studyEndDate <span class="op">=</span> <span class="st">""</span>,</span>
<span>  exposureDatabaseSchema <span class="op">=</span> <span class="va">resultsDatabaseSchema</span>,</span>
<span>  exposureTable <span class="op">=</span> <span class="st">"coxibVsNonselVsGiBleed"</span>,</span>
<span>  outcomeDatabaseSchema <span class="op">=</span> <span class="va">resultsDatabaseSchema</span>,</span>
<span>  outcomeTable <span class="op">=</span> <span class="st">"coxibVsNonselVsGiBleed"</span>,</span>
<span>  cdmVersion <span class="op">=</span> <span class="va">cdmVersion</span>,</span>
<span>  firstExposureOnly <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  removeDuplicateSubjects <span class="op">=</span> <span class="st">"remove all"</span>,</span>
<span>  restrictToCommonPeriod <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  washoutPeriod <span class="op">=</span> <span class="fl">180</span>,</span>
<span>  covariateSettings <span class="op">=</span> <span class="va">covSettings</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cohortMethodData</span></span></code></pre></div>
<p>There are many parameters, but they are all documented in the
<code>CohortMethod</code> manual. The
<code>createDefaultCovariateSettings</code> function is described in the
<code>FeatureExtraction</code> package. In short, we are pointing the
function to the table created earlier and indicating which concept IDs
in that table identify the target, comparator and outcome. We instruct
that the default set of covariates should be constructed, including
covariates for all conditions, drug exposures, and procedures that were
found on or before the index date. To customize the set of covariates,
please refer to the <code>FeatureExtraction</code> package vignette by
typing
<code><a href="https://cran.rstudio.com/web/packages/FeatureExtraction/vignettes/UsingFeatureExtraction.pdf" class="external-link">vignette("UsingFeatureExtraction", package="FeatureExtraction")</a></code>.</p>
<p>All data about the cohorts, outcomes, and covariates are extracted
from the server and stored in the <code>cohortMethodData</code> object.
This object uses the <code>Andromeda</code> package to store information
in a way that ensures R does not run out of memory, even when the data
are large. We can use the generic <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> function to
view some more information of the data we extracted:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">cohortMethodData</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="saving-the-data-to-file">Saving the data to file<a class="anchor" aria-label="anchor" href="#saving-the-data-to-file"></a>
</h4>
<p>Creating the <code>cohortMethodData</code> file can take considerable
computing time, and it is probably a good idea to save it for future
sessions. Because <code>cohortMethodData</code> uses
<code>Andromeda</code>, we cannot use R’s regular save function.
Instead, we’ll have to use the <code><a href="../reference/saveCohortMethodData.html">saveCohortMethodData()</a></code>
function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/saveCohortMethodData.html">saveCohortMethodData</a></span><span class="op">(</span><span class="va">cohortMethodData</span>, <span class="st">"coxibVsNonselVsGiBleed.zip"</span><span class="op">)</span></span></code></pre></div>
<p>We can use the <code><a href="../reference/loadCohortMethodData.html">loadCohortMethodData()</a></code> function to load
the data in a future session.</p>
</div>
<div class="section level4">
<h4 id="defining-new-users">Defining new users<a class="anchor" aria-label="anchor" href="#defining-new-users"></a>
</h4>
<p>Typically, a new user is defined as first time use of a drug (either
target or comparator), and typically a washout period (a minimum number
of days prior first use) is used to make sure it is truly first use.
When using the <code>CohortMethod</code> package, you can enforce the
necessary requirements for new use in three ways:</p>
<ol style="list-style-type: decimal">
<li>When creating the cohorts in the database, for example when using a
cohort definition tool.</li>
<li>When loading the cohorts using the
<code>getDbCohortMethodData</code> function, you can use the
<code>firstExposureOnly</code>, <code>removeDuplicateSubjects</code>,
<code>restrictToCommonPeriod</code>, and <code>washoutPeriod</code>
arguments. (As shown in the example above).</li>
<li>When defining the study population using the
<code>createStudyPopulation</code> function (see below) using the
<code>firstExposureOnly</code>, <code>removeDuplicateSubjects</code>,
<code>restrictToCommonPeriod</code>, and <code>washoutPeriod</code>
arguments.</li>
</ol>
<p>The advantage of option 1 is that the input cohorts are already fully
defined outside of the <code>CohortMethod</code> package, and for
example external cohort characterization tools can be used on the same
cohorts used in this package. The advantage of options 2 and 3 is that
it saves you the trouble of limiting to first use yourself, for example
allowing you to directly use the <code>drug_era</code> table in the CDM.
Option 2 is more efficient than 3, since only data for first use will be
fetched, while option 3 is less efficient but allows you to compare the
original cohorts to the study population.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="defining-the-study-population">Defining the study population<a class="anchor" aria-label="anchor" href="#defining-the-study-population"></a>
</h2>
<p>Typically, the exposure cohorts and outcome cohorts will be defined
independently of each other. When we want to produce an effect size
estimate, we need to further restrict these cohorts and put them
together, for example by removing exposed subjects that had the outcome
prior to exposure, and only keeping outcomes that fall within a defined
risk window. For this we can use the <code>createStudyPopulation</code>
function:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">studyPop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createStudyPopulation.html">createStudyPopulation</a></span><span class="op">(</span></span>
<span>  cohortMethodData <span class="op">=</span> <span class="va">cohortMethodData</span>,</span>
<span>  outcomeId <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  firstExposureOnly <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  restrictToCommonPeriod <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  washoutPeriod <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  removeDuplicateSubjects <span class="op">=</span> <span class="st">"keep all"</span>,</span>
<span>  removeSubjectsWithPriorOutcome <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  minDaysAtRisk <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  riskWindowStart <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  startAnchor <span class="op">=</span> <span class="st">"cohort start"</span>,</span>
<span>  riskWindowEnd <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  endAnchor <span class="op">=</span> <span class="st">"cohort end"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that we’ve set <code>firstExposureOnly</code> and
<code>removeDuplicateSubjects</code> to FALSE, and
<code>washoutPeriod</code> to zero because we already filtered on these
arguments when using the <code>getDbCohortMethodData</code> function.
During loading we set <code>restrictToCommonPeriod</code> to FALSE, and
we do the same here because we do not want to force the comparison to
restrict only to time when both drugs are recorded. We specify the
outcome ID we will use, and that people with outcomes prior to the risk
window start date will be removed. The risk window is defined as
starting at the cohort start date (the index date,
<code>riskWindowStart = 0</code> and
<code>startAnchor = "cohort start"</code>), and the risk windows ends 30
days after the cohort ends (<code>riskWindowEnd = 30</code> and
<code>endAnchor = "cohort end"</code>). Note that the risk windows are
truncated at the end of observation or the study end date. We also
remove subjects who have no time at risk. To see how many people are
left in the study population we can always use the
<code>getAttritionTable</code> function:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getAttritionTable.html">getAttritionTable</a></span><span class="op">(</span><span class="va">studyPop</span><span class="op">)</span></span></code></pre></div>
<p>One additional filtering step that is often used is matching or
trimming on propensity scores, as will be discussed next.</p>
</div>
<div class="section level2">
<h2 id="propensity-scores">Propensity scores<a class="anchor" aria-label="anchor" href="#propensity-scores"></a>
</h2>
<p>The <code>CohortMethod</code> can use propensity scores to adjust for
potential confounders. Instead of the traditional approach of using a
handful of predefined covariates, <code>CohortMethod</code> typically
uses thousands to millions of covariates that are automatically
constructed based on conditions, procedures and drugs in the records of
the subjects.</p>
<div class="section level3">
<h3 id="fitting-a-propensity-model">Fitting a propensity model<a class="anchor" aria-label="anchor" href="#fitting-a-propensity-model"></a>
</h3>
<p>We can fit a propensity model using the covariates constructed by the
<code>getDbcohortMethodData()</code> function:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createPs.html">createPs</a></span><span class="op">(</span>cohortMethodData <span class="op">=</span> <span class="va">cohortMethodData</span>, population <span class="op">=</span> <span class="va">studyPop</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/createPs.html">createPs()</a></code> function uses the <code>Cyclops</code>
package to fit a large-scale regularized logistic regression.</p>
<p>To fit the propensity model, <code>Cyclops</code> needs to know the
hyperparameter value which specifies the variance of the prior. By
default <code>Cyclops</code> will use cross-validation to estimate the
optimal hyperparameter. However, be aware that this can take a really
long time. You can use the <code>prior</code> and <code>control</code>
parameters of the <code><a href="../reference/createPs.html">createPs()</a></code> to specify
<code>Cyclops</code> behavior, including using multiple CPUs to speed-up
the cross-validation.</p>
</div>
<div class="section level3">
<h3 id="propensity-score-diagnostics">Propensity score diagnostics<a class="anchor" aria-label="anchor" href="#propensity-score-diagnostics"></a>
</h3>
<p>We can compute the area under the receiver-operator curve (AUC) for
the propensity score model:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/computePsAuc.html">computePsAuc</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span></span></code></pre></div>
<p>We can also plot the propensity score distribution, although we
prefer the preference score distribution:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotPs.html">plotPs</a></span><span class="op">(</span><span class="va">ps</span>, </span>
<span>       scale <span class="op">=</span> <span class="st">"preference"</span>, </span>
<span>       showCountsLabel <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>       showAucLabel <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>       showEquiposeLabel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>It is also possible to inspect the propensity model itself by showing
the covariates that have non-zero coefficients:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getPsModel.html">getPsModel</a></span><span class="op">(</span><span class="va">ps</span>, <span class="va">cohortMethodData</span><span class="op">)</span></span></code></pre></div>
<p>One advantage of using the regularization when fitting the propensity
model is that most coefficients will shrink to zero and fall out of the
model. It is a good idea to inspect the remaining variables for anything
that should not be there, for example variations of the drugs of
interest that we forgot to exclude.</p>
</div>
<div class="section level3">
<h3 id="using-the-propensity-score">Using the propensity score<a class="anchor" aria-label="anchor" href="#using-the-propensity-score"></a>
</h3>
<p>We can use the propensity scores to trim, stratify, match, or weigh
our population. For example, one could trim to equipoise, meaning only
subjects with a preference score between 0.25 and 0.75 are kept:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trimmedPop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trimByPsToEquipoise.html">trimByPsToEquipoise</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotPs.html">plotPs</a></span><span class="op">(</span><span class="va">trimmedPop</span>, <span class="va">ps</span>, scale <span class="op">=</span> <span class="st">"preference"</span><span class="op">)</span></span></code></pre></div>
<p>Instead (or additionally), we could stratify the population based on
the propensity score:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stratifiedPop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratifyByPs.html">stratifyByPs</a></span><span class="op">(</span><span class="va">ps</span>, numberOfStrata <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotPs.html">plotPs</a></span><span class="op">(</span><span class="va">stratifiedPop</span>, <span class="va">ps</span>, scale <span class="op">=</span> <span class="st">"preference"</span><span class="op">)</span></span></code></pre></div>
<p>We can also match subjects based on propensity scores. In this
example, we’re using one-to-one matching:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">matchedPop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchOnPs.html">matchOnPs</a></span><span class="op">(</span><span class="va">ps</span>, caliper <span class="op">=</span> <span class="fl">0.2</span>, caliperScale <span class="op">=</span> <span class="st">"standardized logit"</span>, maxRatio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/plotPs.html">plotPs</a></span><span class="op">(</span><span class="va">matchedPop</span>, <span class="va">ps</span><span class="op">)</span></span></code></pre></div>
<p>Note that for both stratification and matching it is possible to
specify additional matching criteria such as age and sex using the
<code><a href="../reference/stratifyByPsAndCovariates.html">stratifyByPsAndCovariates()</a></code> and
<code><a href="../reference/matchOnPsAndCovariates.html">matchOnPsAndCovariates()</a></code> functions, respectively.</p>
<p>We can see the effect of trimming and/or matching on the population
using the <code>getAttritionTable</code> function:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getAttritionTable.html">getAttritionTable</a></span><span class="op">(</span><span class="va">matchedPop</span><span class="op">)</span></span></code></pre></div>
<p>Or, if we like, we can plot an attrition diagram:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/drawAttritionDiagram.html">drawAttritionDiagram</a></span><span class="op">(</span><span class="va">matchedPop</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="evaluating-covariate-balance">Evaluating covariate balance<a class="anchor" aria-label="anchor" href="#evaluating-covariate-balance"></a>
</h3>
<p>To evaluate whether our use of the propensity score is indeed making
the two cohorts more comparable, we can compute the covariate balance
before and after trimming, matching, and/or stratifying:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">balance</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/computeCovariateBalance.html">computeCovariateBalance</a></span><span class="op">(</span><span class="va">matchedPop</span>, <span class="va">cohortMethodData</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotCovariateBalanceScatterPlot.html">plotCovariateBalanceScatterPlot</a></span><span class="op">(</span><span class="va">balance</span>, showCovariateCountLabel <span class="op">=</span> <span class="cn">TRUE</span>, showMaxLabel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotCovariateBalanceOfTopVariables.html">plotCovariateBalanceOfTopVariables</a></span><span class="op">(</span><span class="va">balance</span><span class="op">)</span></span></code></pre></div>
<p>The ‘before matching’ population is the population as extracted by
the <code>getDbCohortMethodData</code> function, so before any further
filtering steps.</p>
</div>
<div class="section level3">
<h3 id="inspecting-select-population-characteristics">Inspecting select population characteristics<a class="anchor" aria-label="anchor" href="#inspecting-select-population-characteristics"></a>
</h3>
<p>It is customary to include a table in your paper that lists some
select population characteristics before and after
matching/stratification/trimming. This is usually the first table, and
so will be referred to as ‘table 1’. To generate this table, you can use
the <code>createCmTable1</code> function:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/createCmTable1.html">createCmTable1</a></span><span class="op">(</span><span class="va">balance</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inserting-the-population-cohort-in-the-database">Inserting the population cohort in the database<a class="anchor" aria-label="anchor" href="#inserting-the-population-cohort-in-the-database"></a>
</h3>
<p>For various reasons it might be necessary to insert the study
population back into the database, for example because we want to use an
external cohort characterization tool. We can use the
<code>insertDbPopulation</code> function for this purpose:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">insertDbPopulation</span><span class="op">(</span></span>
<span>  population <span class="op">=</span> <span class="va">matchedPop</span>,</span>
<span>  cohortIds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">101</span>,<span class="fl">100</span><span class="op">)</span>,</span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="va">resultsDatabaseSchema</span>,</span>
<span>  cohortTable <span class="op">=</span> <span class="st">"coxibVsNonselVsGiBleed"</span>,</span>
<span>  createTable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cdmVersion <span class="op">=</span> <span class="va">cdmVersion</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This function will store the population in a table with the same
structure as the <code>cohort</code> table in the CDM, in this case in
the same table where we had created our original cohorts.</p>
</div>
</div>
<div class="section level2">
<h2 id="follow-up-and-power">Follow-up and power<a class="anchor" aria-label="anchor" href="#follow-up-and-power"></a>
</h2>
<p>Before we start fitting an outcome model, we might be interested to
know whether we have sufficient power to detect a particular effect
size. It makes sense to perform these power calculations once the study
population has been fully defined, so taking into account loss to the
various inclusion and exclusion criteria (such as no prior outcomes),
and loss due to matching and/or trimming. Since the sample size is fixed
in retrospective studies (the data has already been collected), and the
true effect size is unknown, the CohortMethod package provides a
function to compute the minimum detectable relative risk (MDRR)
instead:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/computeMdrr.html">computeMdrr</a></span><span class="op">(</span></span>
<span>  population <span class="op">=</span> <span class="va">studyPop</span>,</span>
<span>  modelType <span class="op">=</span> <span class="st">"cox"</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  power <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  twoSided <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In this example we used the <code>studyPop</code> object, so the
population before any matching or trimming. If we want to know the MDRR
after matching, we use the <code>matchedPop</code> object we created
earlier instead:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/computeMdrr.html">computeMdrr</a></span><span class="op">(</span></span>
<span>  population <span class="op">=</span> <span class="va">matchedPop</span>,</span>
<span>  modelType <span class="op">=</span> <span class="st">"cox"</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  power <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  twoSided <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Even thought the MDRR in the matched population is higher, meaning we
have less power, we should of course not be fooled: matching most likely
eliminates confounding, and is therefore preferred to not matching.</p>
<p>To gain a better understanding of the amount of follow-up available
we can also inspect the distribution of follow-up time. We defined
follow-up time as time at risk, so not censored by the occurrence of the
outcome. The <code>getFollowUpDistribution</code> can provide a simple
overview:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getFollowUpDistribution.html">getFollowUpDistribution</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">matchedPop</span><span class="op">)</span></span></code></pre></div>
<p>The output is telling us number of days of follow-up each quantile of
the study population has. We can also plot the distribution:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotFollowUpDistribution.html">plotFollowUpDistribution</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">matchedPop</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="outcome-models">Outcome models<a class="anchor" aria-label="anchor" href="#outcome-models"></a>
</h2>
<p>The outcome model is a model describing which variables are
associated with the outcome.</p>
<div class="section level3">
<h3 id="fitting-a-simple-outcome-model">Fitting a simple outcome model<a class="anchor" aria-label="anchor" href="#fitting-a-simple-outcome-model"></a>
</h3>
<p>In theory we could fit an outcome model without using the propensity
scores. In this example we are fitting an outcome model using a Cox
regression:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcomeModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitOutcomeModel.html">fitOutcomeModel</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">studyPop</span>,</span>
<span>                                modelType <span class="op">=</span> <span class="st">"cox"</span><span class="op">)</span></span>
<span><span class="va">outcomeModel</span></span></code></pre></div>
<p>But of course we want to make use of the matching done on the
propensity score:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcomeModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitOutcomeModel.html">fitOutcomeModel</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">matchedPop</span>,</span>
<span>                                modelType <span class="op">=</span> <span class="st">"cox"</span>,</span>
<span>                                stratified <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">outcomeModel</span></span></code></pre></div>
<p>Note that we define the sub-population to be only those in the
<code>matchedPop</code> object, which we created earlier by matching on
the propensity score. We also now use a stratified Cox model,
conditioning on the propensity score match sets.</p>
<p>Instead of matching or stratifying we can also perform Inverse
Probability of Treatment Weighting (IPTW):</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcomeModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitOutcomeModel.html">fitOutcomeModel</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">ps</span>,</span>
<span>                                modelType <span class="op">=</span> <span class="st">"cox"</span>,</span>
<span>                                inversePtWeighting <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">outcomeModel</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adding-interaction-terms">Adding interaction terms<a class="anchor" aria-label="anchor" href="#adding-interaction-terms"></a>
</h3>
<p>We may be interested whether the effect is different across different
groups in the population. To explore this, we may include interaction
terms in the model. In this example we include three interaction
terms:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interactionCovariateIds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8532001</span>, <span class="fl">201826210</span>, <span class="fl">21600960413</span><span class="op">)</span> </span>
<span><span class="co"># 8532001 = Female</span></span>
<span><span class="co"># 201826210 = Type 2 Diabetes</span></span>
<span><span class="co"># 21600960413 = Concurent use of antithrombotic agents</span></span>
<span><span class="va">outcomeModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitOutcomeModel.html">fitOutcomeModel</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">matchedPop</span>,</span>
<span>                                modelType <span class="op">=</span> <span class="st">"cox"</span>,</span>
<span>                                stratified <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                interactionCovariateIds <span class="op">=</span> <span class="va">interactionCovariateIds</span><span class="op">)</span></span>
<span><span class="va">outcomeModel</span></span></code></pre></div>
<p>Note that you can use the <code>grepCovariateNames</code> to find
covariate IDs.</p>
<p>It is prudent to verify that covariate balance has also been achieved
in the subgroups of interest. For example, we can check the covariate
balance in the subpopulation of females:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">balanceFemale</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/computeCovariateBalance.html">computeCovariateBalance</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">matchedPop</span>, </span>
<span>                                         cohortMethodData <span class="op">=</span> <span class="va">cohortMethodData</span>, </span>
<span>                                         subgroupCovariateId <span class="op">=</span> <span class="fl">8532001</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotCovariateBalanceScatterPlot.html">plotCovariateBalanceScatterPlot</a></span><span class="op">(</span><span class="va">balanceFemale</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adding-covariates-to-the-outcome-model">Adding covariates to the outcome model<a class="anchor" aria-label="anchor" href="#adding-covariates-to-the-outcome-model"></a>
</h3>
<p>One final refinement would be to use the same covariates we used to
fit the propensity model to also fit the outcome model. This way we are
more robust against misspecification of the model, and more likely to
remove bias. For this we use the regularized Cox regression in the
<code>Cyclops</code> package. (Note that the treatment variable is
automatically excluded from regularization.)</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcomeModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitOutcomeModel.html">fitOutcomeModel</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">matchedPop</span>,</span>
<span>                                cohortMethodData <span class="op">=</span> <span class="va">cohortMethodData</span>,</span>
<span>                                modelType <span class="op">=</span> <span class="st">"cox"</span>,</span>
<span>                                stratified <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                useCovariates <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">outcomeModel</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inspecting-the-outcome-model">Inspecting the outcome model<a class="anchor" aria-label="anchor" href="#inspecting-the-outcome-model"></a>
</h3>
<p>We can inspect more details of the outcome model:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">outcomeModel</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">outcomeModel</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can also see the covariates that ended up in the outcome
model:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getOutcomeModel.html">getOutcomeModel</a></span><span class="op">(</span><span class="va">outcomeModel</span>, <span class="va">cohortMethodData</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="kaplan-meier-plot">Kaplan-Meier plot<a class="anchor" aria-label="anchor" href="#kaplan-meier-plot"></a>
</h3>
<p>We can create the Kaplan-Meier plot:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotKaplanMeier.html">plotKaplanMeier</a></span><span class="op">(</span><span class="va">matchedPop</span>, includeZero <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Note that the Kaplan-Meier plot will automatically adjust for any
stratification, matching, or trimming that may have been applied.</p>
</div>
<div class="section level3">
<h3 id="time-to-event-plot">Time-to-event plot<a class="anchor" aria-label="anchor" href="#time-to-event-plot"></a>
</h3>
<p>We can also plot time-to-event, showing both events before and after
the index date, and events during and outside the defined time-at-risk
window. This plot can provide insight into the temporal pattern of the
outcome relative to the exposures:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotTimeToEvent.html">plotTimeToEvent</a></span><span class="op">(</span>cohortMethodData <span class="op">=</span> <span class="va">cohortMethodData</span>,</span>
<span>                outcomeId <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                firstExposureOnly <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                washoutPeriod <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                removeDuplicateSubjects <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                minDaysAtRisk <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                riskWindowStart <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                startAnchor <span class="op">=</span> <span class="st">"cohort start"</span>,</span>
<span>                riskWindowEnd <span class="op">=</span> <span class="fl">30</span>,</span>
<span>                endAnchor <span class="op">=</span> <span class="st">"cohort end"</span><span class="op">)</span></span></code></pre></div>
<p>Note that this plot does not show any adjustment for the propensity
score.</p>
</div>
</div>
<div class="section level2">
<h2 id="acknowledgments">Acknowledgments<a class="anchor" aria-label="anchor" href="#acknowledgments"></a>
</h2>
<p>Considerable work has been dedicated to provide the
<code>CohortMethod</code> package.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span><span class="st">"CohortMethod"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## To cite package 'CohortMethod' in publications use:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   Schuemie M, Suchard M, Ryan P (2022). _CohortMethod: New-User Cohort Method with Large Scale Propensity and Outcome Models_. https://ohdsi.github.io/CohortMethod,</span></span>
<span><span class="co">##   https://github.com/OHDSI/CohortMethod.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## A BibTeX entry for LaTeX users is</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   @Manual{,</span></span>
<span><span class="co">##     title = {CohortMethod: New-User Cohort Method with Large Scale Propensity and Outcome</span></span>
<span><span class="co">## Models},</span></span>
<span><span class="co">##     author = {Martijn Schuemie and Marc Suchard and Patrick Ryan},</span></span>
<span><span class="co">##     year = {2022},</span></span>
<span><span class="co">##     note = {https://ohdsi.github.io/CohortMethod,</span></span>
<span><span class="co">## https://github.com/OHDSI/CohortMethod},</span></span>
<span><span class="co">##   }</span></span></code></pre>
<p>Further, <code>CohortMethod</code> makes extensive use of the
<code>Cyclops</code> package.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span><span class="st">"Cyclops"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## To cite Cyclops in publications use:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   Suchard MA, Simpson SE, Zorych I, Ryan P, Madigan D (2013). "Massive parallelization of serial inference algorithms for complex generalized linear models." _ACM Transactions on</span></span>
<span><span class="co">##   Modeling and Computer Simulation_, *23*, 10. &lt;https://dl.acm.org/doi/10.1145/2414416.2414791&gt;.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## A BibTeX entry for LaTeX users is</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   @Article{,</span></span>
<span><span class="co">##     author = {M. A. Suchard and S. E. Simpson and I. Zorych and P. Ryan and D. Madigan},</span></span>
<span><span class="co">##     title = {Massive parallelization of serial inference algorithms for complex generalized linear models},</span></span>
<span><span class="co">##     journal = {ACM Transactions on Modeling and Computer Simulation},</span></span>
<span><span class="co">##     volume = {23},</span></span>
<span><span class="co">##     pages = {10},</span></span>
<span><span class="co">##     year = {2013},</span></span>
<span><span class="co">##     url = {https://dl.acm.org/doi/10.1145/2414416.2414791},</span></span>
<span><span class="co">##   }</span></span></code></pre>
<p>This work is supported in part through the National Science
Foundation grant IIS 1251151.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martijn Schuemie, Marc Suchard, Patrick Ryan.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
